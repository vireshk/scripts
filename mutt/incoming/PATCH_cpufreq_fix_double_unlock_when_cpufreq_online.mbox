From vireshk  Mon May  9 08:44:24 2022
Delivered-To: viresh.kumar@linaro.org
Received: from pop.gmail.com [142.250.4.108] 	by vireshk-i7 with POP3 (fetchmail-6.4.2) 	for <vireshk@localhost> (single-drop); Mon, 09 May 2022 08:44:24 +0530 (IST)
Received: by 2002:a5e:8b42:0:0:0:0:0 with SMTP id z2csp2806658iom;         Fri, 6 May 2022 10:00:49 -0700 (PDT)
X-Received: by 2002:a05:6638:248c:b0:323:9560:5a7c with SMTP id x12-20020a056638248c00b0032395605a7cmr1917123jat.161.1651856449420;         Fri, 06 May 2022 10:00:49 -0700 (PDT)
ARC-Seal: i=1; a=rsa-sha256; t=1651856449; cv=none;         d=google.com; s=arc-20160816;         b=s/PSy87oHJTMOGEWns01aU0hlmsEQuxWkJtU0NaxXbWGsXuS37mp9uCTDVrYF9i2lx          DVoooP+kZ6o/gaMAMxFAoCBR90NG6MXQn3+Q0wtZgDjKieZYgpiHFQInse93HgJH7qxu          Gx1wPPzhFzCj4UMOVU5tBW7yf3TI+uXdvixHMyAMBuQ5ZZ/hGz2F/YkUv3LAS1jE1IEM          jLi/JAYnkigyOPNJd8x1GkZ8/SKAdMYRvBfoYBiyyedjGSHOb52omjGfhrsMBvlRqRYs          /K0qQsZCuwBildf8HpYwGsatjUyN0f+kabze8IsvEG64q+qCoKMNoaivnaehEfpsXi0z          u0ug==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;         h=content-transfer-encoding:mime-version:references:in-reply-to          :message-id:date:subject:cc:to:from:dkim-signature;         bh=3hv4at3JYf4y09rWLgIApsDSX2KKaSl4kYTsB/P5mJ0=;         b=UMoGBnt0vaVMnbwpfh7P9a53fRfdNwPyZUASaGsjnDKtJTXLg8PHCmpcZnFVf0m2eH          PJy9fOC6GYUjNSCfuEiW28LHQBUaDzwBcKpb70lY1+gljPhPx/22cp7s5Z50Xr6vK+3l          y9lPUbUaBDBPTDV7BsBJlKNKA7jaZfp665/S/XFUdRIUKlVuaVceSJ+DBY5lvOqW+TZe          eLLz55ApXnqPx4ewcmCxAfFAIkPwN7t2BNNMLC/4CUwfbgZ7mSXwNyhR5eXRClKt8KpJ          mQo4zgMenKYmxKHXlWsFH7TyIR2kiFZ8VBcDbSFAMJJNsKI/UOaIuOtL3jxSqYnohQmq          s4Fw==
ARC-Authentication-Results: i=1; mx.google.com;        dkim=pass header.i=@gmail.com header.s=20210112 header.b=gua7RI8q;        spf=pass (google.com: domain of schspa@gmail.com designates 209.85.220.41 as permitted sender) smtp.mailfrom=schspa@gmail.com;        dmarc=pass (p=NONE sp=QUARANTINE dis=NONE) header.from=gmail.com
Return-Path: <schspa@gmail.com>
Received: from mail-sor-f41.google.com (mail-sor-f41.google.com. [209.85.220.41])         by mx.google.com with SMTPS id k15-20020a056e02156f00b002ca79507e4dsor1502277ilu.133.2022.05.06.10.00.49         for <viresh.kumar@linaro.org>         (Google Transport Security);         Fri, 06 May 2022 10:00:49 -0700 (PDT)
Received-SPF: pass (google.com: domain of schspa@gmail.com designates 209.85.220.41 as permitted sender) client-ip=209.85.220.41;
Authentication-Results: mx.google.com;        dkim=pass header.i=@gmail.com header.s=20210112 header.b=gua7RI8q;        spf=pass (google.com: domain of schspa@gmail.com designates 209.85.220.41 as permitted sender) smtp.mailfrom=schspa@gmail.com;        dmarc=pass (p=NONE sp=QUARANTINE dis=NONE) header.from=gmail.com
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;         d=gmail.com; s=20210112;         h=from:to:cc:subject:date:message-id:in-reply-to:references          :mime-version:content-transfer-encoding;         bh=3hv4at3JYf4y09rWLgIApsDSX2KKaSl4kYTsB/P5mJ0=;         b=gua7RI8qZk25ZAewCZAiAJMawwqFhhz80joRswrrSwHhsVDCOOYu8i13fjCzBt77/h          NbNLUJDn8YVcp1T+41qtfChmCn5sms9aEYSKHPEUFPjKcWBvSgi2cSMdHJb/lJ8Rkvz+          X2anB5H7ASVH7YcisrXDldbK8a3ib96x3P5dL08H/Rcybuo+zLoc9AA6dRB1m/ubO4dF          Fha/oqnTvNexNyXgQgkDoLs44Yt0NUj037nxdZaV2JfHyv3ZxHmgu7FeN5koqiKFiSwp          IX7eH+Yic3HhFj4z4mEikD/Zhgyb0iSyeRznbJVTZhpmXlFiF8PCQ0akxhk6PRcU/cge          PEmA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;         d=1e100.net; s=20210112;         h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to          :references:mime-version:content-transfer-encoding;         bh=3hv4at3JYf4y09rWLgIApsDSX2KKaSl4kYTsB/P5mJ0=;         b=Rl4/64kTPmCgqH7uJo6k4kMixm1RsybN6dk0ypUAu2jVYnVHJmCIToBfV4rSveMKtu          GdRsdD0eI7+amfqBLgWBaZNQuZ3vK4+laGXayphC+OUOQRb1QwuUiQi6GGCTjE7qjeRr          06VeA+zhEG2cGYp04xaNas/ES3OW6cUR+ZaDaPPuGGnjh6ZSX1zjNMJTVIXHu//D++ai          lzMAcAAYCF4isMFLqZkj31zdmn0/rlwJwG3AbGcFfhaDSoLD2DUl//AdnKsOxDbUqw+j          UosDY+zkkk/Y0jaZxPBnGMTz0v8MWHSzbN5FEcVyj1d/b6ktlgx/g2aiGR2pHv1NCAef          cQ5g==
X-Gm-Message-State: AOAM533jAUg+EgXq0Uk61yPC1HQN/oNi2eXbCRRSQsiAs+nJ9UI/yBTa 	7QWIapkBl0VPJxzAoSZ52Xs=
X-Google-Smtp-Source: ABdhPJwjp2QyOO3aX6GanfAOk4ePC/7fufotuPndabaMczq0WyiENpJP23ShZvUPg96s0ojmnnoBWA==
X-Received: by 2002:a05:6e02:198e:b0:2cf:4a7a:faf8 with SMTP id g14-20020a056e02198e00b002cf4a7afaf8mr1589453ilf.206.1651856449165;         Fri, 06 May 2022 10:00:49 -0700 (PDT)
Return-Path: <schspa@gmail.com>
Received: from localhost (ec2-13-59-0-164.us-east-2.compute.amazonaws.com. [13.59.0.164])         by smtp.gmail.com with UTF8SMTPSA id f21-20020a05660215d500b0065a47e16f63sm1411863iow.53.2022.05.06.10.00.44         (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);         Fri, 06 May 2022 10:00:48 -0700 (PDT)
From: Schspa Shi <schspa@gmail.com>
To: rafael@kernel.org, 	viresh.kumar@linaro.org, 	dan.carpenter@oracle.com
Cc: linux-pm@vger.kernel.org, 	linux-kernel@vger.kernel.org, 	schspa@gmail.com
Subject: [PATCH] cpufreq: fix double unlock when cpufreq online
Date: Sat,  7 May 2022 01:00:35 +0800
Message-Id: <20220506170035.32115-1-schspa@gmail.com>
X-Mailer: git-send-email 2.24.3 (Apple Git-128)
In-Reply-To: <20220506072146.GD4031@kadam>
References: <20220506072146.GD4031@kadam>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Length: 1775
Lines: 56

The patch f346e96267cd: ("cpufreq: Fix possible race in cpufreq online
error path") expand the critical region. But policy->rwsem is not held when
calling cpufreq_driver->online and cpufreq_driver->init calls, which lead to bad
unlock.

And it's well to hold this lock when calling cpufreq_driver->online, which
provide more protects without bad influence.

Fixes: f346e96267cd: ("cpufreq: Fix possible race in cpufreq online error path")
Link: https://lore.kernel.org/all/YnKZCGaig+EXSowf@kili/

Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
Signed-off-by: Schspa Shi <schspa@gmail.com>
---
 drivers/cpufreq/cpufreq.c | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/drivers/cpufreq/cpufreq.c b/drivers/cpufreq/cpufreq.c
index 0d58b0f8f3af..43dfaa8124e2 100644
--- a/drivers/cpufreq/cpufreq.c
+++ b/drivers/cpufreq/cpufreq.c
@@ -1337,12 +1337,12 @@ static int cpufreq_online(unsigned int cpu)
 		down_write(&policy->rwsem);
 		policy->cpu = cpu;
 		policy->governor = NULL;
-		up_write(&policy->rwsem);
 	} else {
 		new_policy = true;
 		policy = cpufreq_policy_alloc(cpu);
 		if (!policy)
 			return -ENOMEM;
+		down_write(&policy->rwsem);
 	}
 
 	if (!new_policy && cpufreq_driver->online) {
@@ -1382,7 +1382,6 @@ static int cpufreq_online(unsigned int cpu)
 		cpumask_copy(policy->related_cpus, policy->cpus);
 	}
 
-	down_write(&policy->rwsem);
 	/*
 	 * affected cpus must always be the one, which are online. We aren't
 	 * managing offline cpus here.
@@ -1542,9 +1541,9 @@ static int cpufreq_online(unsigned int cpu)
 		cpufreq_driver->exit(policy);
 
 	cpumask_clear(policy->cpus);
-	up_write(&policy->rwsem);
 
 out_free_policy:
+	up_write(&policy->rwsem);
 	cpufreq_policy_free(policy);
 	return ret;
 }
-- 
2.24.3 (Apple Git-128)

