From vireshk  Mon Jan 29 08:42:03 2018
Delivered-To: viresh.kumar@linaro.org
Received: from gmail-pop.l.google.com [74.125.24.108] 	by vireshk-i7 with POP3 (fetchmail-6.3.26) 	for <vireshk@localhost> (single-drop); Mon, 29 Jan 2018 08:42:03 +0530 (IST)
Received: by 10.2.88.8 with SMTP id f8csp402631jab;         Fri, 26 Jan 2018 00:44:20 -0800 (PST)
X-Google-Smtp-Source: AH8x225e7rsbsbuXJxiJpgyFH1Y3GNeS1kS8X0DMn8j1z5a6fIwVAgQPb4tVWZrVGiP4WJ63yBjD
X-Received: by 2002:a17:902:64d6:: with SMTP id y22-v6mr13893443pli.444.1516956260338;         Fri, 26 Jan 2018 00:44:20 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; t=1516956260; cv=none;         d=google.com; s=arc-20160816;         b=ULfqHKSkxQGcKXGGKBJ7MCYbWoIYlzgTTvJCeOnbr4qitRyp6ZVDVy+ww9OUOGqRq/          AVmcOE22EZbwM2IzUJElUOg4Ph3MXKfxWM5nh9JW+dz6Wnmxv5Obqsd6WwPRu1bJuzxF          Sr5Bl9sBwQdAP41z7JNI96MtrAl9L+fTdZIdaHT03NvqziRi+ZIy3cwIrsiduylWbG9a          er4s7KK83YERBH1Dtupfm2uXFVctVpALSIyMBCL6yUjcZCQhkCX5FDmqxjWHs9K/towL          UrRvmYtyXGrZea8uyPe2VLvN2z/N8NiIMcgwAh73Fta5SPPD+BVM1n2jlFU2BdKYylL2          Tr0g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;         h=message-id:date:subject:cc:to:from:dkim-signature:dmarc-filter          :delivered-to:arc-authentication-results;         bh=9UqO9+scgShf64/CCMyt2J44ubsX87xnBQaK67lAGcA=;         b=nLETcUsa4Nu/aTxwl1VO7f+bHvkt1dTQWu8kR7sJhrhHjMz52Mq3w0FwoPFbD63brM          qzmQotN3f/5qP6bVEmLCVxr0aYhoZzI7iACTmctKaN/6XyhwZE8ZwFIh4WmrkkdAHj56          RRjt570DP5mdtpBIiRwZIOyTmNqLKCV3msl1BEPRmBk8HSaHBzX7OwnOkFxhUFaTLNsm          9OgFmDpEVdbSDDRLugBr/hPH9FnLLYgghNCXn/OVs8CcZaVIak/ZB3yrNQhJZFv2y5Y+          46ENPde/VAGqMvXhVKAMZQ1e/j59doMeaiXz1NAkQBAqyJ1ib1GRgMESMPT76uQstZ/A          BwOg==
ARC-Authentication-Results: i=1; mx.google.com;        dkim=pass header.i=@gmail.com header.s=20161025 header.b=Piy8pOam;        spf=pass (google.com: best guess record for domain of srs0=or7x=ev=gmail.com=baijiaju1990@kernel.org designates 198.145.29.99 as permitted sender) smtp.mailfrom=SRS0=Or7x=EV=gmail.com=baijiaju1990@kernel.org;        dmarc=pass (p=NONE sp=NONE dis=NONE) header.from=gmail.com
Return-Path: <SRS0=Or7x=EV=gmail.com=baijiaju1990@kernel.org>
Received: from mail.kernel.org (mail.kernel.org. [198.145.29.99])         by mx.google.com with ESMTPS id r17si2743281pge.478.2018.01.26.00.44.20         for <viresh.kumar@linaro.org>         (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);         Fri, 26 Jan 2018 00:44:20 -0800 (PST)
Received-SPF: pass (google.com: best guess record for domain of srs0=or7x=ev=gmail.com=baijiaju1990@kernel.org designates 198.145.29.99 as permitted sender) client-ip=198.145.29.99;
Authentication-Results: mx.google.com;        dkim=pass header.i=@gmail.com header.s=20161025 header.b=Piy8pOam;        spf=pass (google.com: best guess record for domain of srs0=or7x=ev=gmail.com=baijiaju1990@kernel.org designates 198.145.29.99 as permitted sender) smtp.mailfrom=SRS0=Or7x=EV=gmail.com=baijiaju1990@kernel.org;        dmarc=pass (p=NONE sp=NONE dis=NONE) header.from=gmail.com
Received: by mail.kernel.org (Postfix) 	id 0E2ED217A7; Fri, 26 Jan 2018 08:44:20 +0000 (UTC)
Delivered-To: vireshk@kernel.org
Received: from mail-pg0-f68.google.com (mail-pg0-f68.google.com [74.125.83.68]) 	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits)) 	(No client certificate requested) 	by mail.kernel.org (Postfix) with ESMTPS id EA69D217A2 	for <vireshk@kernel.org>; Fri, 26 Jan 2018 08:44:19 +0000 (UTC)
DMARC-Filter: OpenDMARC Filter v1.3.2 mail.kernel.org EA69D217A2
Authentication-Results: mail.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: mail.kernel.org; spf=pass smtp.mailfrom=baijiaju1990@gmail.com
Received: by mail-pg0-f68.google.com with SMTP id s9so6850741pgq.13         for <vireshk@kernel.org>; Fri, 26 Jan 2018 00:44:19 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;         d=gmail.com; s=20161025;         h=from:to:cc:subject:date:message-id;         bh=9UqO9+scgShf64/CCMyt2J44ubsX87xnBQaK67lAGcA=;         b=Piy8pOamzaJ4qFYYUG0hJYcwe2pC+f89xkxAeFXau/S11md7KoeKx7Z5pE5eQKSXVq          88AmCSVO7FRSTockXzen0Vn8jr0Mo8nr0qV+wxJlVRuKelvrlzK9IcCANdMYR32UwXvu          MBRjA9bwRnP+8U/61yZt3HV7H7daL6WJIDFq4OXgfkxnEdEj16/HLelEIeclRxooecPQ          FVwz8HGPmVqUAjR0SVtBk/eY4qXAfrchi/j41ylN6SqvCBRs5wPnhTsEqFe35GTIjguG          cbMEkG0Gpqom10BfVFCFW92PHz21dq+CRdroqevdEmSBuUzfCMxbpmr3L5wlxv7ugHd0          TvBQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;         d=1e100.net; s=20161025;         h=x-gm-message-state:from:to:cc:subject:date:message-id;         bh=9UqO9+scgShf64/CCMyt2J44ubsX87xnBQaK67lAGcA=;         b=qgO/wckpn5QpipcGFY6EfRhXKHP/nixLYlRPT7xhuwI9Z8efI8fBWzKYI33CO3Jya4          IAbHQBmUf9NhWZ/bMiWBgxJD9siWiHvKPYgOXAo8q4MyY7bYKVxAfZES7AXqNtJX0cN/          25qokaZtvSQemdue1tronAPmFt3FVgQ3wz1iJIzLO5rja7UbrPGFTdkJzxqdEIbrzZea          TpoeogkhrCpXLbyUGYp3h4VyFZCFbnVBbUuKCBOerUUULnpL5rNuBJl8npTtXGBYq1j0          K3g44PJUpzMwOrasQDxa99/NvGJFDC3xtcPZflcKVvPCxuxLnJJKlSNYGQ2Gs8yCPj6u          0iww==
X-Gm-Message-State: AKwxytci6AYyZEcliQbyKrJ9r+/dCgbMQJUs9r+GBCzj7+h6wGjwK4qu 	CK47bStS2pzmoe087O95VpH9BQ==
X-Received: by 2002:a17:902:46:: with SMTP id 64-v6mr13967829pla.341.1516956259036;         Fri, 26 Jan 2018 00:44:19 -0800 (PST)
Received: from bai-oslab.tsinghua.edu.cn ([2402:f000:1:4413:3967:a579:e81d:66fa])         by smtp.gmail.com with ESMTPSA id e3sm18144908pfb.143.2018.01.26.00.44.16         (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);         Fri, 26 Jan 2018 00:44:18 -0800 (PST)
From: Jia-Ju Bai <baijiaju1990@gmail.com>
To: vireshk@kernel.org, 	nm@ti.com, 	sboyd@codeaurora.org
Cc: linux-pm@vger.kernel.org, 	linux-kernel@vger.kernel.org, 	Jia-Ju Bai <baijiaju1990@gmail.com>
Subject: [PATCH] opp: cpu: Replace GFP_ATOMIC with GFP_KERNEL in dev_pm_opp_init_cpufreq_table
Date: Fri, 26 Jan 2018 16:48:49 +0800
Message-Id: <1516956529-32264-1-git-send-email-baijiaju1990@gmail.com>
X-Mailer: git-send-email 1.7.9.5
Content-Length: 1133
Lines: 31

After checking all possible call chains to 
dev_pm_opp_init_cpufreq_table() here,
my tool finds that this function is never called in atomic context, 
namely never in an interrupt handler or holding a spinlock.
And dev_pm_opp_init_cpufreq_table() calls dev_pm_opp_get_opp_count(), 
which calls mutex_lock that can sleep.
It indicates that atmtcp_v_send() can call functions which may sleep.
Thus GFP_ATOMIC is not necessary, and it can be replaced with GFP_KERNEL.

This is found by a static analysis tool named DCNS written by myself.

Signed-off-by: Jia-Ju Bai <baijiaju1990@gmail.com>
---
 drivers/opp/cpu.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/opp/cpu.c b/drivers/opp/cpu.c
index 2d87bc1..0c09107 100644
--- a/drivers/opp/cpu.c
+++ b/drivers/opp/cpu.c
@@ -55,7 +55,7 @@ int dev_pm_opp_init_cpufreq_table(struct device *dev,
 	if (max_opps <= 0)
 		return max_opps ? max_opps : -ENODATA;
 
-	freq_table = kcalloc((max_opps + 1), sizeof(*freq_table), GFP_ATOMIC);
+	freq_table = kcalloc((max_opps + 1), sizeof(*freq_table), GFP_KERNEL);
 	if (!freq_table)
 		return -ENOMEM;
 
-- 
1.7.9.5

