From vireshk  Tue Nov 19 23:28:00 2024
Delivered-To: viresh.kumar@linaro.org
Received: from pop.gmail.com [74.125.200.109] 	by vireshk-i7 with POP3 (fetchmail-6.4.2) 	for <vireshk@localhost> (single-drop); Tue, 19 Nov 2024 23:28:00 +0530 (IST)
Received: by 2002:a05:7208:7012:b0:92:10b5:baa3 with SMTP id n18csp3484319rba;         Tue, 19 Nov 2024 09:56:59 -0800 (PST)
X-Forwarded-Encrypted: i=2; AJvYcCXSuYyagR6wJwijnHFLHXBvwJWbTzQp5QB0XdJfY+CJApwNry+Ckw9vruZE5TsxawoZWS7SFi5OaJGP5TE=@linaro.org
X-Google-Smtp-Source: AGHT+IFcd0NC5Mcxa4O3zLVrtR1mc/92jDpPQghgwtHBbASd6RZ/sa1y6ahLHOmvkfYv8TgdFWdW
X-Received: by 2002:a05:6808:2008:b0:3e5:f534:ddc4 with SMTP id 5614622812f47-3e7bc7b72f2mr16811904b6e.13.1732039018918;         Tue, 19 Nov 2024 09:56:58 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; t=1732039018; cv=none;         d=google.com; s=arc-20240605;         b=dSaAlFECvTYTtdVNo0SFAsYyaLZkZretKQbFFy4/3iwLLHMltagz15R5CCG2S2cfr+          5BLTOCG1OCFb4IOtyRzlHPEwHYdGww8tQ6e3Frt0aGBFjGRR+WEw9AaQt5RZPmn+Ny32          pBVQ1Ovl331GcNWkub2whyXQ8st0ENz+SaYE1uvSyFqCyeWA2dvnLj+A29NmiqFToTx7          u8voxB1sKbD2YTK182uGjo3C23aeLEmQVNloYwKFQLyLf9mnVX4zKhHD23M3JXArnAQw          guAUAa/vZNk6ia62CPBjCgVfR8pgFyzJIYubDrT0IYurw5+x1F05upkMce4+B/eEltcs          ClRA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20240605;         h=cc:to:in-reply-to:references:message-id:content-transfer-encoding          :mime-version:subject:date:from:dkim-signature:dmarc-filter          :delivered-to;         bh=77Eoli2JKcfvmzeyZfmZcAC8ruXlT3sz4RV/g2sy6qg=;         fh=xS8kl7AyrmPCpREdOlLZpPyjGuuOf3qzmHb9mTPyRwg=;         b=C2IIoZZxrzZiYLhyh4uGT3x605R/5cTsO0MZW5uHHd5sF/FKfJSyR9gRokWijcHS33          G6VtliftFoYMcnI42K38Loe4RVbCrcY8YXJJuWD7I5jEa1kjyv8Tj8P83pkTKpiwfGm6          VwCPRAitLKXV6HwrBn9L69yGFYffl4gSAdsdLRnWlyfqMel+Wwhb6lo+jIlW32EZ9lVv          yyIXcSLSNcpEezixZAej+qNqsVmGk+lLbK+R7VPBGRjY+T/D3ntNXTHkgylWQrz+rRbj          dD5Kd4CJdcqSwO4LgkmBnRhU0S4XR5dUZxcam8yQ5EEG1+k/a2eh9PYSV6oM0UI9dc5p          HAQg==;         dara=google.com
ARC-Authentication-Results: i=1; mx.google.com;        dkim=pass header.i=@linaro.org header.s=google header.b=x4u7cKhW;        spf=pass (google.com: domain of srs0=2kul=so=linaro.org=neil.armstrong@kernel.org designates 2604:1380:4641:c500::1 as permitted sender) smtp.mailfrom="SRS0=2kuL=SO=linaro.org=neil.armstrong@kernel.org";        dmarc=pass (p=NONE sp=NONE dis=NONE) header.from=linaro.org;        dara=neutral header.i=@linaro.org
Return-Path: <SRS0=2kuL=SO=linaro.org=neil.armstrong@kernel.org>
Received: from dfw.source.kernel.org (dfw.source.kernel.org. [2604:1380:4641:c500::1])         by mx.google.com with ESMTPS id 5614622812f47-3e7bcd9b1fasi5533508b6e.262.2024.11.19.09.56.58         for <viresh.kumar@linaro.org>         (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);         Tue, 19 Nov 2024 09:56:58 -0800 (PST)
Received-SPF: pass (google.com: domain of srs0=2kul=so=linaro.org=neil.armstrong@kernel.org designates 2604:1380:4641:c500::1 as permitted sender) client-ip=2604:1380:4641:c500::1;
Authentication-Results: mx.google.com;        dkim=pass header.i=@linaro.org header.s=google header.b=x4u7cKhW;        spf=pass (google.com: domain of srs0=2kul=so=linaro.org=neil.armstrong@kernel.org designates 2604:1380:4641:c500::1 as permitted sender) smtp.mailfrom="SRS0=2kuL=SO=linaro.org=neil.armstrong@kernel.org";        dmarc=pass (p=NONE sp=NONE dis=NONE) header.from=linaro.org;        dara=neutral header.i=@linaro.org
Received: from smtp.kernel.org (transwarp.subspace.kernel.org [100.75.92.58]) 	by dfw.source.kernel.org (Postfix) with ESMTP id 96C575C4B4D 	for <viresh.kumar@linaro.org>; Tue, 19 Nov 2024 17:56:14 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) 	id 6259FC4CEFA; Tue, 19 Nov 2024 17:56:58 +0000 (UTC)
Delivered-To: vireshk@kernel.org
Received: from mail-wm1-f49.google.com (mail-wm1-f49.google.com [209.85.128.49]) 	(using TLSv1.3 with cipher TLS_AES_128_GCM_SHA256 (128/128 bits) 	 key-exchange X25519 server-signature RSA-PSS (2048 bits) server-digest SHA256) 	(No client certificate requested) 	by smtp.kernel.org (Postfix) with ESMTPS id 94509C4CEE9 	for <vireshk@kernel.org>; Tue, 19 Nov 2024 17:56:48 +0000 (UTC)
DMARC-Filter: OpenDMARC Filter v1.4.1 smtp.kernel.org 94509C4CEE9
Authentication-Results: smtp.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org
Authentication-Results: smtp.kernel.org; spf=pass smtp.mailfrom=linaro.org
Received: by mail-wm1-f49.google.com with SMTP id 5b1f17b1804b1-4316f3d3c21so48552205e9.3         for <vireshk@kernel.org>; Tue, 19 Nov 2024 09:56:47 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;         d=linaro.org; s=google; t=1732039006; x=1732643806; darn=kernel.org;         h=cc:to:in-reply-to:references:message-id:content-transfer-encoding          :mime-version:subject:date:from:from:to:cc:subject:date:message-id          :reply-to;         bh=77Eoli2JKcfvmzeyZfmZcAC8ruXlT3sz4RV/g2sy6qg=;         b=x4u7cKhWkX+8y56QpFuEKIz01LE7nwkzjXnuGKvdxLSlUV2AviekcLPuvi6D0dh54a          kpU1KYGCrSr/OZq5wquptZJVnYWH8bL/0GO3QTidFh6/hqaPPb4Wry49kfJmj4yoUmBd          7XFnR1Kx6xuy4HBBpNzyxFFCft/+rVTNGhec4Daou6gcUkuuOk04bMksq/RZ+es0AOGh          lB+Qh8R1ICh/H4ieQLfmnONevDWmgm8Djz1k3nAwXGPhsqPPszoNmpRQ6CQbJXcmzv9f          tb7CeQeSki6DZuTM7ZFFKun+iNnhMP4pCWRY2jBS82pm1oHpuH+qeI+C2SjcbHbclEVP          aQjA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;         d=1e100.net; s=20230601; t=1732039006; x=1732643806;         h=cc:to:in-reply-to:references:message-id:content-transfer-encoding          :mime-version:subject:date:from:x-gm-message-state:from:to:cc          :subject:date:message-id:reply-to;         bh=77Eoli2JKcfvmzeyZfmZcAC8ruXlT3sz4RV/g2sy6qg=;         b=fuIpF8o/TD19axuIvL2mi6Wxn287glfsCfw8fOb4QX6bXCkXAH01ouzdHIz0M8ffwl          C1jPCPd24wq23j5W+LytoVjbGU4Fwzpr/1+El9Tsu4bg3vXtwnBSLwXAPSXzeXvwZxAH          NrTkW7CK943DlmNvyBXOE6cUfZ98Anzwux6yT62VEQPAVFpZi+OY7/awR7XHO05zTQFM          PUQp5EFaBana8k8P7SK/iILujvikxj6VSsm9bpbC9WQ9gWY+9ZCiH48MOj/QaVpiNmC4          g5E+GzXqkfPjmB0rI3b9LsyL4jLzSnQGCvJJYyNh2r1KNfyxEKSVVuu8UN4vWFLtezVE          Qecg==
X-Forwarded-Encrypted: i=1; AJvYcCWqJsdl2C4kJgjnYI0fQEb8l2eCrUCd0i/PBqLt44qy6+/oNToyWHSLTiutULOOOozI5t/VfN9K@kernel.org
X-Gm-Message-State: AOJu0YykdPvmYAtCCbnteRE9pndvpZVBbF0crmbzoYhDzGVxVmhXRtiI 	UpA0L595JCUUsAK1xcom+PUvP7ZRNMi3DeF1wtGbRwo+sN3EqNsqHu7KFlebFzs=
X-Received: by 2002:a05:600c:35c8:b0:430:57f2:bae2 with SMTP id 5b1f17b1804b1-432df791f62mr123906335e9.23.1732039006322;         Tue, 19 Nov 2024 09:56:46 -0800 (PST)
Received: from arrakeen.starnux.net ([2a01:e0a:982:cbb0:52eb:f6ff:feb3:451a])         by smtp.gmail.com with ESMTPSA id 5b1f17b1804b1-432da27fe68sm208302275e9.24.2024.11.19.09.56.45         (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);         Tue, 19 Nov 2024 09:56:45 -0800 (PST)
From: Neil Armstrong <neil.armstrong@linaro.org>
Date: Tue, 19 Nov 2024 18:56:36 +0100
Subject: [PATCH v2 01/11] opp: core: implement dev_pm_opp_get_bw
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Message-Id: <20241119-topic-sm8x50-gpu-bw-vote-v2-1-4deb87be2498@linaro.org>
References: <20241119-topic-sm8x50-gpu-bw-vote-v2-0-4deb87be2498@linaro.org>
In-Reply-To: <20241119-topic-sm8x50-gpu-bw-vote-v2-0-4deb87be2498@linaro.org>
To: Akhil P Oommen <quic_akhilpo@quicinc.com>,   Viresh Kumar <vireshk@kernel.org>, Nishanth Menon <nm@ti.com>,   Stephen Boyd <sboyd@kernel.org>, "Rafael J. Wysocki" <rafael@kernel.org>,   Rob Clark <robdclark@gmail.com>, Sean Paul <sean@poorly.run>,   Konrad Dybcio <konradybcio@kernel.org>,   Abhinav Kumar <quic_abhinavk@quicinc.com>,   Dmitry Baryshkov <dmitry.baryshkov@linaro.org>,   Marijn Suijten <marijn.suijten@somainline.org>,   David Airlie <airlied@gmail.com>, Simona Vetter <simona@ffwll.ch>,   Bjorn Andersson <andersson@kernel.org>, Rob Herring <robh@kernel.org>,   Krzysztof Kozlowski <krzk+dt@kernel.org>,   Conor Dooley <conor+dt@kernel.org>
Cc: Connor Abbott <cwabbott0@gmail.com>, linux-pm@vger.kernel.org,   linux-kernel@vger.kernel.org, linux-arm-msm@vger.kernel.org,   dri-devel@lists.freedesktop.org, freedreno@lists.freedesktop.org,   devicetree@vger.kernel.org, Neil Armstrong <neil.armstrong@linaro.org>
X-Mailer: b4 0.14.2
X-Developer-Signature: v=1; a=openpgp-sha256; l=2743;  i=neil.armstrong@linaro.org; h=from:subject:message-id;  bh=jYCp8TR7dzoclrZB3zyNwAn2VlLPZL58y51ut7TpNS0=;  b=owEBbQKS/ZANAwAKAXfc29rIyEnRAcsmYgBnPNFXzHRfip66xeIvRHFGvMRVvKXc3AYGENiBWrVV  6SXuRnuJAjMEAAEKAB0WIQQ9U8YmyFYF/h30LIt33NvayMhJ0QUCZzzRVwAKCRB33NvayMhJ0btFEA  CxS/Y3wNk1GVdwKy07e3iKyukBHX2qmyQj6NiA9v2ta5Cz/uPNSaS8Tc32gJESqqwJojuIQlF7k4No  DynYwa/WDju9SFUVD1z2cMFL+FCvgSRWaqWCLqR7cGJMvMgyZlMv7zR9WYa7M5wJ/MNzYn91nUDvCa  3//OfR6I3DwpaHFLewgE8rLC9ZB3RLsi4RzMKGsK+IKXcvsbmbPJf+HjgFYMSAc8PW/I2tvWQ/InSy  gFFZjfXuvRuLrZWHqT1Gi4rRicne6TRCYpLh4p+BFUxe5KnEGDZg8o3ceWMxwKor4TSaVQQTKsnNWt  W/GPR6N7GgzTLxQO6epXobNAUv02VeDNUs66KIY7rUF4qy3sMI6G+aTf9vE0w/g8Fd3u1YaOE3N8o1  nxMzXagpNBdnf9rI110qFeirQMY6ZIp57HyQbmKVK1Vk0R0VM46MLCJdfp5t7I0/NU7NG4If6uYuqK  PLKl+kOpOLIq8yaTA/vpvfP5uV0q/3HYIBx/QJAHJIYUtp3PMoCTj+VYqhHaQ6bGrK9iaqwNAorqeO  8VefKlo8kKdPgB6/7ip8k2Y625U0EHqOAdluF4+kCxGD+T0qLHefkoqkSSmaHYSoVHzL7H6hVZZPzq  wMkQtSkoWZmSqTLDUZZWPPkznILvnx0n/3S8aVEASCP32GztYdODY1Npp8GQ==
X-Developer-Key: i=neil.armstrong@linaro.org; a=openpgp;  fpr=89EC3D058446217450F22848169AB7B1A4CFF8AE
Content-Length: 2663
Lines: 80

Add and implement the dev_pm_opp_get_bw() to retrieve
the OPP's bandwidth in the same way as the dev_pm_opp_get_voltage()
helper.

Retrieving bandwidth is required in the case of the Adreno GPU
where the GPU Management Unit can handle the Bandwidth scaling.

The helper can get the peak or average bandwidth for any of
the interconnect path.

Signed-off-by: Neil Armstrong <neil.armstrong@linaro.org>
---
 drivers/opp/core.c     | 25 +++++++++++++++++++++++++
 include/linux/pm_opp.h |  7 +++++++
 2 files changed, 32 insertions(+)

diff --git a/drivers/opp/core.c b/drivers/opp/core.c
index 494f8860220d97fc690ebab5ed3b7f5f04f22d73..864b9b99b0129acaffaf45c584c5f34b8bababed 100644
--- a/drivers/opp/core.c
+++ b/drivers/opp/core.c
@@ -106,6 +106,31 @@ static bool assert_single_clk(struct opp_table *opp_table)
 	return !WARN_ON(opp_table->clk_count > 1);
 }
 
+/**
+ * dev_pm_opp_get_bw() - Gets the bandwidth corresponding to an opp
+ * @opp:	opp for which voltage has to be returned for
+ * @peak:	select peak or average bandwidth
+ * @index:	bandwidth index
+ *
+ * Return: bandwidth in kBps, else return 0
+ */
+unsigned long dev_pm_opp_get_bw(struct dev_pm_opp *opp, bool peak, int index)
+{
+	if (IS_ERR_OR_NULL(opp)) {
+		pr_err("%s: Invalid parameters\n", __func__);
+		return 0;
+	}
+
+	if (index > opp->opp_table->path_count)
+		return 0;
+
+	if (!opp->bandwidth)
+		return 0;
+
+	return peak ? opp->bandwidth[index].peak : opp->bandwidth[index].avg;
+}
+EXPORT_SYMBOL_GPL(dev_pm_opp_get_bw);
+
 /**
  * dev_pm_opp_get_voltage() - Gets the voltage corresponding to an opp
  * @opp:	opp for which voltage has to be returned for
diff --git a/include/linux/pm_opp.h b/include/linux/pm_opp.h
index 6424692c30b71fca471a1b7d63e018605dd9324b..cd9a257b8e7766d6c8631351a10a845c88414a74 100644
--- a/include/linux/pm_opp.h
+++ b/include/linux/pm_opp.h
@@ -106,6 +106,8 @@ struct dev_pm_opp_data {
 struct opp_table *dev_pm_opp_get_opp_table(struct device *dev);
 void dev_pm_opp_put_opp_table(struct opp_table *opp_table);
 
+unsigned long dev_pm_opp_get_bw(struct dev_pm_opp *opp, bool peak, int index);
+
 unsigned long dev_pm_opp_get_voltage(struct dev_pm_opp *opp);
 
 int dev_pm_opp_get_supplies(struct dev_pm_opp *opp, struct dev_pm_opp_supply *supplies);
@@ -209,6 +211,11 @@ static inline struct opp_table *dev_pm_opp_get_opp_table_indexed(struct device *
 
 static inline void dev_pm_opp_put_opp_table(struct opp_table *opp_table) {}
 
+static inline unsigned long dev_pm_opp_get_bw(struct dev_pm_opp *opp, bool peak, int index)
+{
+	return 0;
+}
+
 static inline unsigned long dev_pm_opp_get_voltage(struct dev_pm_opp *opp)
 {
 	return 0;

-- 
2.34.1

