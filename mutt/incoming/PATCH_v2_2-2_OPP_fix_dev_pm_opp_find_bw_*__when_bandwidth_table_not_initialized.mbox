From vireshk  Mon Dec  2 08:30:42 2024
Delivered-To: viresh.kumar@linaro.org
Received: from pop.gmail.com [74.125.200.109] 	by vireshk-i7 with POP3 (fetchmail-6.4.2) 	for <vireshk@localhost> (single-drop); Mon, 02 Dec 2024 08:30:42 +0530 (IST)
Received: by 2002:a05:7208:c0e:b0:92:10b5:baa3 with SMTP id ix14csp601033rbb;         Fri, 29 Nov 2024 07:06:38 -0800 (PST)
X-Google-Smtp-Source: AGHT+IFDdd53xRJxbVuhyOMer+FNJKCPDCSuum8CL1fipomm5v74NgfKrA+W6w7n+Zj3jNbiTpOq
X-Received: by 2002:a05:6870:56a0:b0:297:2515:156c with SMTP id 586e51a60fabf-29dc432c97amr10249179fac.30.1732892798062;         Fri, 29 Nov 2024 07:06:38 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; t=1732892798; cv=none;         d=google.com; s=arc-20240605;         b=ZQ1C+1c03ToY9LAzOSVVVIbiC/RqNWM6FasNlIMqKujEneVTA9m2rp61ZUWYenB6K/          +5oLevXAokX/g0JnPHngQZMZGWNMUhfzjyKnnGrQtx0hC55dgB6RvbUB/2D8+E/1sQO1          l2bjzXAYZQ3heTGsWC7FHEUbrjJKJyy5nCH8xb+rkt2s2uu6u0C9BQG1bPBNYDfnU2jv          7PcNI23w8X02xRWSZ7kiN4zhOQiE8noJuCvxY2YZMbjIkM1oSgvHXJK5ZXXBgn6z34qc          xpPj3JsSST8V+XxQiOssr8REM+oA08WQubkFkSy4wtxloCW8BZQe4qcIbtk//cxsJd2O          2w4A==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20240605;         h=cc:to:in-reply-to:references:message-id:content-transfer-encoding          :mime-version:subject:date:from:dkim-signature:dmarc-filter          :delivered-to;         bh=AVplK0gY4Tmc9m/uCWwm84G2EK5ABI9/9ThqPRIIUiE=;         fh=/k6wi4CqSzzU4H2vrBE/Jgfp0kCFSfkdgL3qlFlxJOk=;         b=dT8ewHbMVn9hdw5zrFxIR3QRhX8sNEYfmRgXWPW4uwkSF8156GRa2oAD2BUwmkzpPG          0F2P4L8IN0MVY2XTjOCC400Tp59UeCMq8ASLce+3I0JEzMvqMm+PxNnWn7KDpgen++/k          Hs2eriZ9vQrmEpOZqcQShmjM4g55187Jf4MHHTHCRN98gjbBO7kx3w0FkX4+meRYixez          ybdUIjwjnsYZ71xkObNChKRGjLp3/giH89mH/i+qlejghb1NpXJ0gNcaWPzlGdAb8AWl          nBC5mMHLSE9UwDKCNs9UMAQpwavpFxG92l1zASnvJAJEPia6t1L310Ow3cpmVDnX/d8D          TYfA==;         dara=google.com
ARC-Authentication-Results: i=1; mx.google.com;        dkim=pass header.i=@linaro.org header.s=google header.b=bAoMyU1d;        spf=pass (google.com: domain of srs0=pkv7=sy=linaro.org=neil.armstrong@kernel.org designates 2604:1380:4641:c500::1 as permitted sender) smtp.mailfrom="SRS0=PkV7=SY=linaro.org=neil.armstrong@kernel.org";        dmarc=pass (p=NONE sp=NONE dis=NONE) header.from=linaro.org;        dara=neutral header.i=@linaro.org
Return-Path: <SRS0=PkV7=SY=linaro.org=neil.armstrong@kernel.org>
Received: from dfw.source.kernel.org (dfw.source.kernel.org. [2604:1380:4641:c500::1])         by mx.google.com with ESMTPS id 586e51a60fabf-29e2d6ddf4dsi604906fac.245.2024.11.29.07.06.37         for <viresh.kumar@linaro.org>         (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);         Fri, 29 Nov 2024 07:06:38 -0800 (PST)
Received-SPF: pass (google.com: domain of srs0=pkv7=sy=linaro.org=neil.armstrong@kernel.org designates 2604:1380:4641:c500::1 as permitted sender) client-ip=2604:1380:4641:c500::1;
Authentication-Results: mx.google.com;        dkim=pass header.i=@linaro.org header.s=google header.b=bAoMyU1d;        spf=pass (google.com: domain of srs0=pkv7=sy=linaro.org=neil.armstrong@kernel.org designates 2604:1380:4641:c500::1 as permitted sender) smtp.mailfrom="SRS0=PkV7=SY=linaro.org=neil.armstrong@kernel.org";        dmarc=pass (p=NONE sp=NONE dis=NONE) header.from=linaro.org;        dara=neutral header.i=@linaro.org
Received: from smtp.kernel.org (transwarp.subspace.kernel.org [100.75.92.58]) 	by dfw.source.kernel.org (Postfix) with ESMTP id 73FA35C5903 	for <viresh.kumar@linaro.org>; Fri, 29 Nov 2024 15:05:54 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) 	id 4E4ADC4CED9; Fri, 29 Nov 2024 15:06:37 +0000 (UTC)
Delivered-To: vireshk@kernel.org
Received: from mail-wm1-f53.google.com (mail-wm1-f53.google.com [209.85.128.53]) 	(using TLSv1.3 with cipher TLS_AES_128_GCM_SHA256 (128/128 bits) 	 key-exchange X25519 server-signature RSA-PSS (2048 bits) server-digest SHA256) 	(No client certificate requested) 	by smtp.kernel.org (Postfix) with ESMTPS id 3A0FFC4CED4 	for <vireshk@kernel.org>; Fri, 29 Nov 2024 15:06:36 +0000 (UTC)
DMARC-Filter: OpenDMARC Filter v1.4.1 smtp.kernel.org 3A0FFC4CED4
Authentication-Results: smtp.kernel.org; dmarc=pass (p=none dis=none) header.from=linaro.org
Authentication-Results: smtp.kernel.org; spf=pass smtp.mailfrom=linaro.org
Received: by mail-wm1-f53.google.com with SMTP id 5b1f17b1804b1-434a45f05feso21720585e9.3         for <vireshk@kernel.org>; Fri, 29 Nov 2024 07:06:35 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;         d=linaro.org; s=google; t=1732892794; x=1733497594; darn=kernel.org;         h=cc:to:in-reply-to:references:message-id:content-transfer-encoding          :mime-version:subject:date:from:from:to:cc:subject:date:message-id          :reply-to;         bh=AVplK0gY4Tmc9m/uCWwm84G2EK5ABI9/9ThqPRIIUiE=;         b=bAoMyU1dOlxO69Gq6NZssBSKVURGSvmxCUxDN+4bzhuWdIuAMVswc4w3Q8fnMux14B          rgGMvLhtBp2SibEZshSTgQsrHbsdxaV6hsu89lYpZEwMj3FMdDA0GhJc69xMHhOT1hKP          juiFZypeD7DqNQyw27aRFQ27amXnivAEtCQD0CGg6jEifUaA4yxtHhdCiX7SIjyDoY1L          lLRAd3MqeX432KFI5JANthK6K6dHfTsahRuecJne5GSQLKB86ZH6zMvRQrOFjmWB089P          1+Qk0d2D6JhM9d1VNZ67XkFRPw+forcOZLl2um0NSHTbYdk+8B0wIc9XmCoDo6JNNaZ9          VhOg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;         d=1e100.net; s=20230601; t=1732892794; x=1733497594;         h=cc:to:in-reply-to:references:message-id:content-transfer-encoding          :mime-version:subject:date:from:x-gm-message-state:from:to:cc          :subject:date:message-id:reply-to;         bh=AVplK0gY4Tmc9m/uCWwm84G2EK5ABI9/9ThqPRIIUiE=;         b=LGf+c7q+L2XK9SvPdZQDzanZcOBY1bR0GshhKQLX4GlJRXhh/jrkVre7i3f6d8WxKF          ygmoquGnDJX7Z2sQ2zdRjvfMZXlnrvHA3fQ0nzBu/GPAvROSdLYvFotTbVcaeb+7eH9F          NgwwLMEkzh79inVFXu5wYUvnMLQGpdDbzP1Tuz5Vqpkseszvc8ncFU7DCxMZdOd0gfgT          bj5QnqokwoRd+9RsweK1/vzZsd8ZsVSWGEguPL4Kz9dcL5gfYOJe4PG1rzrMTQOC2Y/S          CopzpH61sVB40b1krpnSQHRxDzrAgC26F3XRCgCT4NrtyXB0AzTbV457Rgj/kETvm2Oh          ksJA==
X-Gm-Message-State: AOJu0Yz60u1I1lkAnK2iHNQsPtURKnMSvyPND+iZTxqLTZShOqLCX2zG 	ZLfiZgdZLS308lThcqS/Zbg1R+EEAv0OVQicC6+4YmSYuhfKLaYkjjC+MlcLeiE=
X-Gm-Gg: ASbGncuYZ8fC2ehekDRPbl8eFpYc//jFyUCzhZ6fhC8XMDHivdCQP2WR3efNUx9fuRb 	sCC13cqMdQxzWYFPsOdreto1jLZWC4+yd++2VUQeuSljsynR/vQRofrssLNVHLh4ujfo075/b7l 	8K2tD31JBp956JZyKxiVekwNs9issR53ay54q+nKXQ3h+A1tcVQ7Am2Y/uTvbISmoy12mPMsvOe 	SN6qOzES4ISrcAU19kkx/kCm2pPmxcASOOhUPRuWC5OR8kn4unOz4JFrRf3mAQjtYP3XOM=
X-Received: by 2002:a05:6000:188d:b0:385:ded5:86ee with SMTP id ffacd0b85a97d-385ded587c2mr3550345f8f.57.1732892793791;         Fri, 29 Nov 2024 07:06:33 -0800 (PST)
Received: from arrakeen.starnux.net ([2a01:e0a:982:cbb0:52eb:f6ff:feb3:451a])         by smtp.gmail.com with ESMTPSA id ffacd0b85a97d-385ccd2df65sm4759637f8f.6.2024.11.29.07.06.33         (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);         Fri, 29 Nov 2024 07:06:33 -0800 (PST)
From: Neil Armstrong <neil.armstrong@linaro.org>
Date: Fri, 29 Nov 2024 16:06:25 +0100
Subject: [PATCH v2 2/2] OPP: fix dev_pm_opp_find_bw_*() when bandwidth  table not initialized
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Message-Id: <20241129-topic-opp-fix-assert-index-check-v2-2-386b2dcbb9a6@linaro.org>
References: <20241129-topic-opp-fix-assert-index-check-v2-0-386b2dcbb9a6@linaro.org>
In-Reply-To: <20241129-topic-opp-fix-assert-index-check-v2-0-386b2dcbb9a6@linaro.org>
To: Viresh Kumar <vireshk@kernel.org>, Nishanth Menon <nm@ti.com>,   Stephen Boyd <sboyd@kernel.org>,   Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Cc: Viresh Kumar <viresh.kumar@linaro.org>, linux-pm@vger.kernel.org,   linux-kernel@vger.kernel.org, Neil Armstrong <neil.armstrong@linaro.org>
X-Mailer: b4 0.14.2
X-Developer-Signature: v=1; a=openpgp-sha256; l=2343;  i=neil.armstrong@linaro.org; h=from:subject:message-id;  bh=9yHf0KJWm0K/IY4/jKLBMpZERAg9i0/ucu034t8ZUuM=;  b=owEBbQKS/ZANAwAKAXfc29rIyEnRAcsmYgBnSdhyA5K9LuQf2hibSwfMOcLoWPeVKDCzr8fh4fDg  vEz0EhmJAjMEAAEKAB0WIQQ9U8YmyFYF/h30LIt33NvayMhJ0QUCZ0nYcgAKCRB33NvayMhJ0e0PD/  423aI0Dmnr1QZ6PDbOOOuhw4LGjo5XIuoi8jI3fIshhu8/Hw1ZIbsxkwOkDKd6+NjTvZhuy/ZMwal1  jeV3NfZykvRRTux3EJ0U0xoE2Zb1jrywxp1q5a5pnI0cdbOWfX239x89gEtMhwC/x3KHFyCsWVyLo5  GjJ86edXwEZSjHbYaoQLhtAI9bSuay94hM+LA2dr1IiGnEUflsGwFO1gwp7rfEh+SSNrHW6igh/Jk6  AItaIdUJTxW+LFosDfo2p5lrt19lvkiSyoOTJ+QOq9o5y9OxpyRy1KYP11WN5e9cqjd5BcVwTL+3f0  KIYr6MxOK4ncX7q2CaHtE1bMhqg8520W2P6lNzUk0jrLR36fq0lL2+KohC2bOvHOYiN8VX7pMpF6Gf  vFDiENUjQpOn5snFoX5wM5FWqt/Q7MCf1CRNGPfU0z4xLgPmPgY/6RihvCctYduv+v/8WcCWh5Hmmq  LE1rvSRU3h9/LD9kqoXKGkjCg4y/VOw7bh+W2L9ntR101JgDaHjlfbrNus6O67LNRY6keSBHx3g5AQ  76QZIqPAG8bHg5jfAZt69k384Satzq1UNrFIyH/NCKfW2ragquOCFDCBHn79teS2OlZBnDjwDmal7h  HKBKwK8bx4XkkEakV28IEk0YSuhUlInb3D+jsAXUJj6DOW1gErL4PpglS+Ag==
X-Developer-Key: i=neil.armstrong@linaro.org; a=openpgp;  fpr=89EC3D058446217450F22848169AB7B1A4CFF8AE
Content-Length: 2274
Lines: 69

If a driver calls dev_pm_opp_find_bw_ceil/floor() the retrieve bandwidth
from the OPP table but the bandwidth table was not created because the
interconnect properties were missing in the OPP consumer node, the
kernel will crash with:

Unable to handle kernel NULL pointer dereference at virtual address 0000000000000004
...
pc : _read_bw+0x8/0x10
lr : _opp_table_find_key+0x9c/0x174
...
Call trace:
  _read_bw+0x8/0x10 (P)
  _opp_table_find_key+0x9c/0x174 (L)
  _find_key+0x98/0x168
  dev_pm_opp_find_bw_ceil+0x50/0x88
...

In order to fix the crash, create an assert function to check
if the bandwidth table was created before trying to get a
bandwidth with _read_bw().

Fixes: add1dc094a74 ("OPP: Use generic key finding helpers for bandwidth key")
Signed-off-by: Neil Armstrong <neil.armstrong@linaro.org>
---
 drivers/opp/core.c | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/drivers/opp/core.c b/drivers/opp/core.c
index 52c6a45ceb7479c3ef0ed97ab43a37546d695c7f..c7d16b2c5110089aeb35012be1dc35dfd209963e 100644
--- a/drivers/opp/core.c
+++ b/drivers/opp/core.c
@@ -114,6 +114,14 @@ static bool assert_clk_index(struct opp_table *opp_table, int index)
 	return opp_table->clk_count > index;
 }
 
+/*
+ * Returns true if bandwidth table is large enough to contain the bandwidth index.
+ */
+static bool assert_bandwidth_index(struct opp_table *opp_table, int index)
+{
+	return opp_table->path_count > index;
+}
+
 /**
  * dev_pm_opp_get_bw() - Gets the bandwidth corresponding to an opp
  * @opp:	opp for which bandwidth has to be returned for
@@ -913,7 +921,8 @@ struct dev_pm_opp *dev_pm_opp_find_bw_ceil(struct device *dev, unsigned int *bw,
 	unsigned long temp = *bw;
 	struct dev_pm_opp *opp;
 
-	opp = _find_key_ceil(dev, &temp, index, true, _read_bw, NULL);
+	opp = _find_key_ceil(dev, &temp, index, true, _read_bw,
+			     assert_bandwidth_index);
 	*bw = temp;
 	return opp;
 }
@@ -944,7 +953,8 @@ struct dev_pm_opp *dev_pm_opp_find_bw_floor(struct device *dev,
 	unsigned long temp = *bw;
 	struct dev_pm_opp *opp;
 
-	opp = _find_key_floor(dev, &temp, index, true, _read_bw, NULL);
+	opp = _find_key_floor(dev, &temp, index, true, _read_bw,
+			      assert_bandwidth_index);
 	*bw = temp;
 	return opp;
 }

-- 
2.34.1

