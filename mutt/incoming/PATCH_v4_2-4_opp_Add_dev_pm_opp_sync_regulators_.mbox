From vireshk  Thu Jan 21 03:57:14 2021
Delivered-To: viresh.kumar@linaro.org
Received: from pop.gmail.com [74.125.24.109] 	by vireshk-i7 with POP3 (fetchmail-6.3.26) 	for <vireshk@localhost> (single-drop); Thu, 21 Jan 2021 03:57:14 +0530 (IST)
Received: by 2002:a5e:c813:0:0:0:0:0 with SMTP id y19csp530389iol;         Wed, 20 Jan 2021 14:27:06 -0800 (PST)
X-Google-Smtp-Source: ABdhPJzeYApxUseJY541ZTNhxFaXkKoj4we1SZO57zVfInBCLlLW+Lm6iPAuMPyGRR97yjzC9VtD
X-Received: by 2002:a63:d855:: with SMTP id k21mr11302795pgj.399.1611181626333;         Wed, 20 Jan 2021 14:27:06 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; t=1611181626; cv=none;         d=google.com; s=arc-20160816;         b=tPsndulo7QQrs7S+8FYNq74/tsQ/5HDb+rWn5AyHvjwacCGfQGkvb8UgdOws2MdzlR          /mzJ5eQ3ofdKLHX/4e571eumWYt2MNtIMyaa7o93QSfyQlaSXp8Rm7lfIHPqh+611USt          vEaW+QU6gu3cOzj5eHRqRXi9lAXLwI7T5Qkf5c8In9wK1/ZtyVAiFsoPlkRDS9jViXhB          Ec8wvC4iveW0liEYBYxwcb3Zvt87tjzhFYFx+HpqzMc/PRR8gMPvE/VR7rxrpH19dkbp          HxME2GrNGdseydZWcK1AP6Do+D/HM+6jiUqnzIOvXvWK6yEHG3/zMRLGOwQ+vAbJMAbM          wBsg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;         h=content-transfer-encoding:mime-version:references:in-reply-to          :message-id:date:subject:cc:to:from:dkim-signature:dmarc-filter          :delivered-to;         bh=4sp7b1NkfUJTCMUO91JmNlpsU6mJZQVutgbbdE6RDGY=;         b=SwMwjlwYzRpo71dswTj5BfLi3D6UE5o2OZaPMvNyap2uBE/UxM7gfYocVCyOQPEz8V          Sldc8Ip5aDNltuM4GqE3TH0tPbdcp5MFDV2GoDu2lszdC5btMCdegpfkJYQPg/7UpINg          e3qKsANqnjAkNibwv7hI14nZHNRDlMRmmvD7Q+X0qSVhXzttnMz4HLmKCxAzixwR0T2c          mgcLmU4TH4M0KD23IllTZ8yQSjNShop+9FCTGSCgGa5tttU1zrTV1taPNFURmd3pwM2B          io9yU9QGOIepy/rPkSw4N3lkxYNnLh25Mxrec1MoZ3Fhl1z2SKZE71A7mouDd6UeTSAq          ezYg==
ARC-Authentication-Results: i=1; mx.google.com;        dkim=pass header.i=@gmail.com header.s=20161025 header.b=aUke85Vs;        spf=pass (google.com: domain of srs0=vdvm=gx=gmail.com=digetx@kernel.org designates 198.145.29.99 as permitted sender) smtp.mailfrom="SRS0=VDVm=GX=gmail.com=digetx@kernel.org";        dmarc=pass (p=NONE sp=QUARANTINE dis=NONE) header.from=gmail.com
Return-Path: <SRS0=VDVm=GX=gmail.com=digetx@kernel.org>
Received: from mail.kernel.org (mail.kernel.org. [198.145.29.99])         by mx.google.com with ESMTPS id r7si3892112pjp.55.2021.01.20.14.27.06         for <viresh.kumar@linaro.org>         (version=TLS1_2 cipher=ECDHE-ECDSA-AES128-GCM-SHA256 bits=128/128);         Wed, 20 Jan 2021 14:27:06 -0800 (PST)
Received-SPF: pass (google.com: domain of srs0=vdvm=gx=gmail.com=digetx@kernel.org designates 198.145.29.99 as permitted sender) client-ip=198.145.29.99;
Authentication-Results: mx.google.com;        dkim=pass header.i=@gmail.com header.s=20161025 header.b=aUke85Vs;        spf=pass (google.com: domain of srs0=vdvm=gx=gmail.com=digetx@kernel.org designates 198.145.29.99 as permitted sender) smtp.mailfrom="SRS0=VDVm=GX=gmail.com=digetx@kernel.org";        dmarc=pass (p=NONE sp=QUARANTINE dis=NONE) header.from=gmail.com
Received: by mail.kernel.org (Postfix) 	id E003C233EA; Wed, 20 Jan 2021 22:27:05 +0000 (UTC)
Delivered-To: vireshk@kernel.org
Received: from mail-wr1-f46.google.com (mail-wr1-f46.google.com [209.85.221.46]) 	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits)) 	(No client certificate requested) 	by mail.kernel.org (Postfix) with ESMTPS id 6C119221FD; 	Wed, 20 Jan 2021 22:27:05 +0000 (UTC)
DMARC-Filter: OpenDMARC Filter v1.3.2 mail.kernel.org 6C119221FD
Authentication-Results: mail.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: mail.kernel.org; spf=pass smtp.mailfrom=digetx@gmail.com
Received: by mail-wr1-f46.google.com with SMTP id w5so24554985wrm.11;         Wed, 20 Jan 2021 14:27:05 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;         d=gmail.com; s=20161025;         h=from:to:cc:subject:date:message-id:in-reply-to:references          :mime-version:content-transfer-encoding;         bh=4sp7b1NkfUJTCMUO91JmNlpsU6mJZQVutgbbdE6RDGY=;         b=aUke85VsKCiPdz0Alc+YVwiQ0D4OI3iN5Q/Ft5p4OGNth9UBoPyxKCjWVccoJDPdQD          2xYsS/Ad1rMamkETdZCN7KobY1i6BY7N4PdnqimTfhKA5xdCKuZMMT7mAq+xWWO8etZx          yoLyG4tpxW0gttL2py33fOhMJNJIJvb44mp3HSa8miGwftaFdn5v4cyG9G/e8InCzOWb          MlL8C9t886/SfzTV92Y9oCLdIhVSyDVuDsxj9xRzpVnSojas25y0LQBY+TM6QoMmbqYD          4+jGnIb/57fKBM/Zn4ogILKlQ6I2bgKCi80H8ldygDZsVQPiP1AuBSXfA+zObYKoi7D1          4zdw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;         d=1e100.net; s=20161025;         h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to          :references:mime-version:content-transfer-encoding;         bh=4sp7b1NkfUJTCMUO91JmNlpsU6mJZQVutgbbdE6RDGY=;         b=Kju+uNAvqTECIwXbNOWDkVIt9x0Wvwei5bh1NJ614doEs5GfRtUVrRvK3MwauK9B9W          tls+Ao+ZXxBzMqNREs3bvMQSw4IzHpns+OuKBPRTbYwIRZGilVP+rVrvgqUcPsIwj12w          7fa8FETRjKfVFvD8HGu3F86eeLws12Z4Vjc5J/SoWjXQ2ssbFHENddE6Xe0hPfXSW5Lw          qaHpmGDciMScasvwdjf6/EKQQUnKiQ/xVo7XfC0GftY0MurCCkOLuXSO97xd25UGfgXh          qjAHpwBQtUSE4XV1O9Tuy/bYXZ/XAUGoqg+UuYP6FBQzjJ6ZOatqo0thZUEVaOMOB3Mc          NhwQ==
X-Gm-Message-State: AOAM532EDdIlvOtkJ3Ztnf4Dj9gRHEADIsFTdpf5fdE/HcInDHygKKGF 	uomKoT+PvdH+IfNQoyKKFzc=
X-Received: by 2002:adf:f8d2:: with SMTP id f18mr4353685wrq.238.1611181623894;         Wed, 20 Jan 2021 14:27:03 -0800 (PST)
Received: from localhost.localdomain (109-252-192-57.dynamic.spd-mgts.ru. [109.252.192.57])         by smtp.gmail.com with ESMTPSA id i131sm5663710wmi.25.2021.01.20.14.27.02         (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);         Wed, 20 Jan 2021 14:27:03 -0800 (PST)
From: Dmitry Osipenko <digetx@gmail.com>
To: Thierry Reding <thierry.reding@gmail.com>, 	Jonathan Hunter <jonathanh@nvidia.com>, 	Mark Brown <broonie@kernel.org>, 	Liam Girdwood <lgirdwood@gmail.com>, 	Ulf Hansson <ulf.hansson@linaro.org>, 	Peter Geis <pgwipeout@gmail.com>, 	Nicolas Chauvet <kwizart@gmail.com>, 	"Rafael J. Wysocki" <rjw@rjwysocki.net>, 	Kevin Hilman <khilman@kernel.org>, 	Peter De Schrijver <pdeschrijver@nvidia.com>, 	Viresh Kumar <vireshk@kernel.org>, 	Stephen Boyd <sboyd@kernel.org>, 	Nishanth Menon <nm@ti.com>, 	Yangtao Li <tiny.windzz@gmail.com>, 	Matt Merhar <mattmerhar@protonmail.com>
Cc: linux-kernel@vger.kernel.org, 	linux-tegra@vger.kernel.org, 	linux-pm@vger.kernel.org
Subject: [PATCH v4 2/4] opp: Add dev_pm_opp_sync_regulators()
Date: Thu, 21 Jan 2021 01:26:47 +0300
Message-Id: <20210120222649.28149-3-digetx@gmail.com>
X-Mailer: git-send-email 2.29.2
In-Reply-To: <20210120222649.28149-1-digetx@gmail.com>
References: <20210120222649.28149-1-digetx@gmail.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Status: RO
Content-Length: 2651
Lines: 87

Extend OPP API with dev_pm_opp_sync_regulators() function, which syncs
voltage state of regulators.

Tested-by: Peter Geis <pgwipeout@gmail.com>
Tested-by: Nicolas Chauvet <kwizart@gmail.com>
Tested-by: Matt Merhar <mattmerhar@protonmail.com>
Signed-off-by: Dmitry Osipenko <digetx@gmail.com>
---
 drivers/opp/core.c     | 41 +++++++++++++++++++++++++++++++++++++++++
 include/linux/pm_opp.h |  6 ++++++
 2 files changed, 47 insertions(+)

diff --git a/drivers/opp/core.c b/drivers/opp/core.c
index 6049b17f99d6..43e62e0e3d5b 100644
--- a/drivers/opp/core.c
+++ b/drivers/opp/core.c
@@ -2659,3 +2659,44 @@ void dev_pm_opp_remove_table(struct device *dev)
 	dev_pm_opp_put_opp_table(opp_table);
 }
 EXPORT_SYMBOL_GPL(dev_pm_opp_remove_table);
+
+/**
+ * dev_pm_opp_sync_regulators() - Sync state of voltage regulators
+ * @dev:	device for which we do this operation
+ *
+ * Sync voltage state of the OPP table regulators.
+ *
+ * Return: 0 on success or a negative error value.
+ */
+int dev_pm_opp_sync_regulators(struct device *dev)
+{
+	struct opp_table *opp_table;
+	struct regulator *reg;
+	int i, ret = 0;
+
+	/* Device may not have OPP table */
+	opp_table = _find_opp_table(dev);
+	if (IS_ERR(opp_table))
+		return 0;
+
+	/* Regulator may not be required for the device */
+	if (!opp_table->regulators)
+		goto put_table;
+
+	/* Nothing to sync if voltage wasn't changed */
+	if (!opp_table->enabled)
+		goto put_table;
+
+	for (i = 0; i < opp_table->regulator_count; i++) {
+		reg = opp_table->regulators[i];
+		ret = regulator_sync_voltage(reg);
+		if (ret)
+			break;
+	}
+put_table:
+	/* Drop reference taken by _find_opp_table() */
+	dev_pm_opp_put_opp_table(opp_table);
+
+	return ret;
+}
+EXPORT_SYMBOL_GPL(dev_pm_opp_sync_regulators);
diff --git a/include/linux/pm_opp.h b/include/linux/pm_opp.h
index f8e9a8e3eb59..80cdb9af8268 100644
--- a/include/linux/pm_opp.h
+++ b/include/linux/pm_opp.h
@@ -163,6 +163,7 @@ int dev_pm_opp_set_sharing_cpus(struct device *cpu_dev, const struct cpumask *cp
 int dev_pm_opp_get_sharing_cpus(struct device *cpu_dev, struct cpumask *cpumask);
 void dev_pm_opp_remove_table(struct device *dev);
 void dev_pm_opp_cpumask_remove_table(const struct cpumask *cpumask);
+int dev_pm_opp_sync_regulators(struct device *dev);
 #else
 static inline struct opp_table *dev_pm_opp_get_opp_table(struct device *dev)
 {
@@ -399,6 +400,11 @@ static inline void dev_pm_opp_cpumask_remove_table(const struct cpumask *cpumask
 {
 }
 
+static inline int dev_pm_opp_sync_regulators(struct device *dev)
+{
+	return -ENOTSUPP;
+}
+
 #endif		/* CONFIG_PM_OPP */
 
 #if defined(CONFIG_PM_OPP) && defined(CONFIG_OF)
-- 
2.29.2

