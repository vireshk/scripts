From vireshk  Thu Jan 21 03:58:18 2021
Delivered-To: viresh.kumar@linaro.org
Received: from pop.gmail.com [74.125.24.109] 	by vireshk-i7 with POP3 (fetchmail-6.3.26) 	for <vireshk@localhost> (single-drop); Thu, 21 Jan 2021 03:58:18 +0530 (IST)
Received: by 2002:a5e:c813:0:0:0:0:0 with SMTP id y19csp530425iol;         Wed, 20 Jan 2021 14:27:09 -0800 (PST)
X-Google-Smtp-Source: ABdhPJw4MlAY0cqb1X1UJ1ErnAFCcvz8nHqe+FC96XOe0gkgyGOxw/kYNTU30heb1ZR33rjqrjqU
X-Received: by 2002:a63:7708:: with SMTP id s8mr11462140pgc.437.1611181629535;         Wed, 20 Jan 2021 14:27:09 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; t=1611181629; cv=none;         d=google.com; s=arc-20160816;         b=Cu5F5YN/pTsvPnolPay/ejBc+Ia6cYy4joFPKajLLBklG0WwPFWftPNkwuIYAOwGCR          h0DJmLQ0nl/uVzEYtc47qyEaqnOJ3X01e0MWYnDO0NAnHfBzc3AGxD++rQ6gwDQ/V6DG          oewsvko/9mnHFfZzqcvHc39v95M9Dfs7brF90xDGYcbke9O+QYFRJYg1roVVHgk8YoEm          WL1lt4QWcRPcuPM8GyDW4KsulWqz9EEFNDYEw62xKxQRHGm203Um5NMtYyRsxpbL27kg          FQnlV6m/7nMHkp4a09WWRtbb2LcDDau4P7JoCPZhHJQ5mr/d46sKZny4qXczgBfAlBfo          H4+g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;         h=content-transfer-encoding:mime-version:references:in-reply-to          :message-id:date:subject:cc:to:from:dkim-signature:dmarc-filter          :delivered-to;         bh=h2RhxkAG+uWAbxkgUJeC5MykXJe6T4j02mxuLjKdXRQ=;         b=vqo8HDMzF60t1JcuuKMMYDmi0T4TRsGV1RIL+ywK7/tPTM3S6d2qv57wwlEEpN/TPk          GQ0eGi5OMinm+v/yTBz/y0boYiogc7iAyJIsN8YIsa90KmNUEGuSzHjqseaUJFEF0Pw1          Zde5Snnepw/qJt6o3zcB7ZCakSe+4Q0Zkc9/tP3i8+btv4Go9KurCOD0jr5RCu21dxRW          eBxU9pt82AA/38qauw+iaOhkHgVuypcRlg2TppRqJHF2tF1jE53QBGZJ3qrA+wM4XtOJ          IdKRxfcLqlYEZrYQrSNOPTAQHR0T8xDhgqb91sYbyydae7zNzylOfMLgXfKZv6Hlo9AZ          Qwzg==
ARC-Authentication-Results: i=1; mx.google.com;        dkim=pass header.i=@gmail.com header.s=20161025 header.b=REnxKbz0;        spf=pass (google.com: domain of srs0=vdvm=gx=gmail.com=digetx@kernel.org designates 198.145.29.99 as permitted sender) smtp.mailfrom="SRS0=VDVm=GX=gmail.com=digetx@kernel.org";        dmarc=pass (p=NONE sp=QUARANTINE dis=NONE) header.from=gmail.com
Return-Path: <SRS0=VDVm=GX=gmail.com=digetx@kernel.org>
Received: from mail.kernel.org (mail.kernel.org. [198.145.29.99])         by mx.google.com with ESMTPS id k2si2387878pfa.325.2021.01.20.14.27.09         for <viresh.kumar@linaro.org>         (version=TLS1_2 cipher=ECDHE-ECDSA-AES128-GCM-SHA256 bits=128/128);         Wed, 20 Jan 2021 14:27:09 -0800 (PST)
Received-SPF: pass (google.com: domain of srs0=vdvm=gx=gmail.com=digetx@kernel.org designates 198.145.29.99 as permitted sender) client-ip=198.145.29.99;
Authentication-Results: mx.google.com;        dkim=pass header.i=@gmail.com header.s=20161025 header.b=REnxKbz0;        spf=pass (google.com: domain of srs0=vdvm=gx=gmail.com=digetx@kernel.org designates 198.145.29.99 as permitted sender) smtp.mailfrom="SRS0=VDVm=GX=gmail.com=digetx@kernel.org";        dmarc=pass (p=NONE sp=QUARANTINE dis=NONE) header.from=gmail.com
Received: by mail.kernel.org (Postfix) 	id 0589823731; Wed, 20 Jan 2021 22:27:09 +0000 (UTC)
Delivered-To: vireshk@kernel.org
Received: from mail-wm1-f45.google.com (mail-wm1-f45.google.com [209.85.128.45]) 	(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits)) 	(No client certificate requested) 	by mail.kernel.org (Postfix) with ESMTPS id 7DE4B23437; 	Wed, 20 Jan 2021 22:27:08 +0000 (UTC)
DMARC-Filter: OpenDMARC Filter v1.3.2 mail.kernel.org 7DE4B23437
Authentication-Results: mail.kernel.org; dmarc=pass (p=none dis=none) header.from=gmail.com
Authentication-Results: mail.kernel.org; spf=pass smtp.mailfrom=digetx@gmail.com
Received: by mail-wm1-f45.google.com with SMTP id i63so4100078wma.4;         Wed, 20 Jan 2021 14:27:08 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;         d=gmail.com; s=20161025;         h=from:to:cc:subject:date:message-id:in-reply-to:references          :mime-version:content-transfer-encoding;         bh=h2RhxkAG+uWAbxkgUJeC5MykXJe6T4j02mxuLjKdXRQ=;         b=REnxKbz0huwqlEYZ3Lht12zcAp9m9NJo0l6vOBvaq7V71JJ0R3Yn28L2OIGtecdU20          /sMYeF2+mSC1B0LXmYdIpB5TfrdH/2YA9h57Jsto34DV1Hsu1oohiXNfKbJb0zYm2Gty          cVNcjrpqZgNoBrnYpa6OHifIfFYFkGhk3fmidM3qYevQO9COiwMj7/Hr8WtG8RurPzpc          NXHZRFbk2LcQ+jFksfDnIlZExIAlG1vUMxxU//YCJdIjMjhhKrG1hU2Vg2dfQbJ/tsj2          Md/x5R059pUUlkQSSRuRmFZh1y9SODC7836qyMOennaBn6SChqhMiQ2+VCOpJTiZ9ehb          iZCA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;         d=1e100.net; s=20161025;         h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to          :references:mime-version:content-transfer-encoding;         bh=h2RhxkAG+uWAbxkgUJeC5MykXJe6T4j02mxuLjKdXRQ=;         b=IZGJQyXXrSr9jK6JC2LUIZ+9eH2yyX37/Kg3N1V3BR7G6/sgCYa2hD2XBEZ6ZJtPWg          7JYkvmlRK/yXtrvz0SS5nsUG/boYK2eAHdwTDajrsadKJEA76CE6T94yCE6FFEsqr8aB          zykIxtMR+H1p4YGGK0trwzxbDESLokxZpw7Hl27FEE/52QNTG9p1Z15Ur0lqT5uXnNl3          DrbmiMN+qOMSIf6i4i3dPa0i/+8sXSbWsnztHuGYlrmLW//ogtayYRSE9/c1R4CLH0ti          +jZzYDQFdFr6lObauoh761d8NP39X5rwGTzAExjkdMIpIelOrURB3hRy0LXLSqfZwfqj          nWcA==
X-Gm-Message-State: AOAM530tZvbTA/wNjAUXHKqX1uu6TXlN4Vh2t8vgIQ2ympITKEb9sr1r 	pKhG5soCnhV9Sm8gyuaJDxk=
X-Received: by 2002:a1c:6089:: with SMTP id u131mr6146036wmb.99.1611181626987;         Wed, 20 Jan 2021 14:27:06 -0800 (PST)
Received: from localhost.localdomain (109-252-192-57.dynamic.spd-mgts.ru. [109.252.192.57])         by smtp.gmail.com with ESMTPSA id i131sm5663710wmi.25.2021.01.20.14.27.05         (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);         Wed, 20 Jan 2021 14:27:06 -0800 (PST)
From: Dmitry Osipenko <digetx@gmail.com>
To: Thierry Reding <thierry.reding@gmail.com>, 	Jonathan Hunter <jonathanh@nvidia.com>, 	Mark Brown <broonie@kernel.org>, 	Liam Girdwood <lgirdwood@gmail.com>, 	Ulf Hansson <ulf.hansson@linaro.org>, 	Peter Geis <pgwipeout@gmail.com>, 	Nicolas Chauvet <kwizart@gmail.com>, 	"Rafael J. Wysocki" <rjw@rjwysocki.net>, 	Kevin Hilman <khilman@kernel.org>, 	Peter De Schrijver <pdeschrijver@nvidia.com>, 	Viresh Kumar <vireshk@kernel.org>, 	Stephen Boyd <sboyd@kernel.org>, 	Nishanth Menon <nm@ti.com>, 	Yangtao Li <tiny.windzz@gmail.com>, 	Matt Merhar <mattmerhar@protonmail.com>
Cc: linux-kernel@vger.kernel.org, 	linux-tegra@vger.kernel.org, 	linux-pm@vger.kernel.org
Subject: [PATCH v4 4/4] opp: Make _set_opp_custom() work without regulators
Date: Thu, 21 Jan 2021 01:26:49 +0300
Message-Id: <20210120222649.28149-5-digetx@gmail.com>
X-Mailer: git-send-email 2.29.2
In-Reply-To: <20210120222649.28149-1-digetx@gmail.com>
References: <20210120222649.28149-1-digetx@gmail.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Length: 1684
Lines: 56

Check whether OPP table has regulators in _set_opp_custom() and set up
dev_pm_set_opp_data accordingly. Now _set_opp_custom() works properly,
i.e. it doesn't crash if OPP table doesn't have assigned regulators.

Signed-off-by: Dmitry Osipenko <digetx@gmail.com>
---
 drivers/opp/core.c | 26 +++++++++++++++++---------
 1 file changed, 17 insertions(+), 9 deletions(-)

diff --git a/drivers/opp/core.c b/drivers/opp/core.c
index 08d205a55c07..c38ac1cf62ac 100644
--- a/drivers/opp/core.c
+++ b/drivers/opp/core.c
@@ -829,23 +829,31 @@ static int _set_opp_custom(const struct opp_table *opp_table,
 			   struct dev_pm_opp_supply *new_supply)
 {
 	struct dev_pm_set_opp_data *data;
-	int size;
+	int size, regulator_count;
+
+	if (opp_table->sod_supplies)
+		regulator_count = opp_table->regulator_count;
+	else
+		regulator_count = 0;
 
 	data = opp_table->set_opp_data;
 	data->regulators = opp_table->regulators;
-	data->regulator_count = opp_table->regulator_count;
+	data->regulator_count = regulator_count;
 	data->clk = opp_table->clk;
 	data->dev = dev;
 
 	data->old_opp.rate = old_freq;
-	size = sizeof(*old_supply) * opp_table->regulator_count;
-	if (!old_supply)
-		memset(data->old_opp.supplies, 0, size);
-	else
-		memcpy(data->old_opp.supplies, old_supply, size);
-
 	data->new_opp.rate = freq;
-	memcpy(data->new_opp.supplies, new_supply, size);
+
+	if (regulator_count) {
+		size = sizeof(*old_supply) * opp_table->regulator_count;
+		if (!old_supply)
+			memset(data->old_opp.supplies, 0, size);
+		else
+			memcpy(data->old_opp.supplies, old_supply, size);
+
+		memcpy(data->new_opp.supplies, new_supply, size);
+	}
 
 	return opp_table->set_opp(data);
 }
-- 
2.29.2

